<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WITW26 — Smoky Mountain Routes</title>
<meta name="theme-color" content="#060609">
<link rel="manifest" href="/manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #060609;
  --bg-panel: rgba(8, 8, 14, 0.94);
  --bg-hover: rgba(255, 255, 255, 0.03);
  --bg-active: rgba(255, 255, 255, 0.06);
  --border: rgba(255, 255, 255, 0.05);
  --border-accent: rgba(0, 210, 255, 0.12);
  --text: #9a9ab0;
  --text-dim: #505068;
  --text-bright: #e4e4f0;
  --accent: #00d2ff;
  --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
  --font-sans: 'Inter', -apple-system, sans-serif;
}

html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font-sans); overflow: hidden; }

/* ── Layout ─────────────────────────── */
#app { display: flex; height: 100vh; }

#sidebar {
  width: 340px;
  min-width: 340px;
  background: var(--bg-panel);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  z-index: 10;
  position: relative;
}

/* Subtle scanline texture on sidebar */
#sidebar::after {
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,0,0,0.03) 2px,
    rgba(0,0,0,0.03) 4px
  );
  pointer-events: none;
  z-index: 1;
}

#map-container { flex: 1; position: relative; }
#map { width: 100%; height: 100%; }

/* ── Header ─────────────────────────── */
.header {
  padding: 20px 18px 14px;
  border-bottom: 1px solid var(--border);
  position: relative;
}

.header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
  opacity: 0.3;
}

.header-title {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 8px;
}

.header-title .blink {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 8px var(--accent);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.header-sub {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-dim);
  letter-spacing: 1px;
  margin-top: 4px;
  text-transform: uppercase;
}

.stats {
  display: flex;
  gap: 2px;
  margin-top: 14px;
}

.stat-cell {
  flex: 1;
  background: rgba(255,255,255,0.02);
  border: 1px solid var(--border);
  padding: 8px 10px;
  text-align: center;
}

.stat-cell:first-child { border-radius: 4px 0 0 4px; }
.stat-cell:last-child { border-radius: 0 4px 4px 0; }

.stat-val {
  font-family: var(--font-mono);
  font-size: 18px;
  font-weight: 700;
  color: var(--text-bright);
  line-height: 1;
}

.stat-label {
  font-family: var(--font-mono);
  font-size: 8px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-top: 4px;
}

/* ── Search ─────────────────────────── */
.search {
  padding: 10px 18px;
  border-bottom: 1px solid var(--border);
}

.search input {
  width: 100%;
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 7px 10px;
  color: var(--text-bright);
  font: 11px var(--font-mono);
  outline: none;
  transition: border-color 0.2s;
}

.search input::placeholder { color: var(--text-dim); }
.search input:focus { border-color: var(--border-accent); }

/* ── Folders ────────────────────────── */
.folders {
  flex: 1;
  overflow-y: auto;
  position: relative;
  z-index: 2;
  scrollbar-width: thin;
  scrollbar-color: rgba(255,255,255,0.06) transparent;
}

.folders::-webkit-scrollbar { width: 4px; }
.folders::-webkit-scrollbar-track { background: transparent; }
.folders::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 2px; }

.folder { border-bottom: 1px solid var(--border); }

.folder-head {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 18px;
  cursor: pointer;
  transition: background 0.12s;
  user-select: none;
}

.folder-head:hover { background: var(--bg-hover); }

.f-toggle {
  width: 10px;
  height: 10px;
  border: 1.5px solid;
  border-radius: 2px;
  flex-shrink: 0;
  cursor: pointer;
  position: relative;
  transition: all 0.15s;
}

.f-toggle.on::after {
  content: '';
  position: absolute;
  inset: 1px;
  border-radius: 1px;
  background: currentColor;
  box-shadow: 0 0 6px currentColor;
}

.f-chevron {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
  transition: transform 0.2s;
  color: var(--text-dim);
  opacity: 0.5;
}

.f-chevron.open { transform: rotate(90deg); opacity: 0.8; }

.f-name {
  font: 600 10px var(--font-mono);
  letter-spacing: 0.5px;
  color: var(--text-bright);
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.f-badge {
  font: 500 9px var(--font-mono);
  color: var(--text-dim);
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid var(--border);
  padding: 1px 5px;
  border-radius: 3px;
}

.f-items { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
.f-items.open { max-height: 2000px; }

.f-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 18px 5px 40px;
  cursor: pointer;
  transition: background 0.12s;
  font: 400 9px var(--font-mono);
  letter-spacing: 0.3px;
  color: var(--text);
}

.f-item:hover { background: var(--bg-hover); color: var(--text-bright); }
.f-item.tour-focus {
  background: rgba(0, 210, 255, 0.06);
  color: var(--text-bright);
  border-left: 2px solid var(--accent);
  padding-left: 38px;
}
.f-item:last-child { padding-bottom: 8px; }

.f-item-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  flex-shrink: 0;
}

.f-item-dot.route {
  width: 12px;
  height: 2px;
  border-radius: 1px;
}

.f-item-name {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.f-item-tag {
  font: 500 8px var(--font-mono);
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* ── Tooltip ────────────────────────── */
.tooltip {
  position: absolute;
  pointer-events: none;
  background: rgba(8, 8, 14, 0.95);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 14px;
  font-size: 11px;
  max-width: 260px;
  z-index: 100;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  box-shadow: 0 4px 24px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.02);
  display: none;
}

.tooltip::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  border-radius: 6px 6px 0 0;
}

.tt-name {
  font-weight: 600;
  color: var(--text-bright);
  font-size: 12px;
  margin-bottom: 2px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.tt-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.tt-folder {
  font: 500 9px var(--font-mono);
  color: var(--text-dim);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.tt-desc {
  font-size: 10px;
  color: var(--text);
  margin-top: 6px;
  line-height: 1.5;
}

/* ── HUD Overlay ────────────────────── */
.hud-panel {
  position: absolute;
  z-index: 50;
  pointer-events: none;
}

.hud-tl { top: 16px; left: 16px; }
.hud-tr { top: 16px; right: 16px; }
.hud-bl { bottom: 44px; left: 16px; width: 280px; }

.hud-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(6, 6, 9, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.04);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  padding: 5px 10px;
  border-radius: 3px;
  margin-bottom: 4px;
}

.hud-lbl {
  font: 500 8px var(--font-mono);
  letter-spacing: 2px;
  text-transform: uppercase;
  color: rgba(255, 255, 255, 0.18);
}

.hud-val {
  font: 600 11px var(--font-mono);
  letter-spacing: 1.5px;
  color: rgba(255, 255, 255, 0.5);
  font-variant-numeric: tabular-nums;
}

.hud-val .hi {
  color: var(--accent);
  opacity: 0.7;
}

/* Coords — the big flat readout */
.hud-coords-panel {
  display: flex;
  gap: 1px;
}

.hud-coord-cell {
  background: rgba(6, 6, 9, 0.65);
  border: 1px solid rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  padding: 6px 12px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.hud-coord-cell:first-child { border-radius: 3px 0 0 3px; }
.hud-coord-cell:last-child { border-radius: 0 3px 3px 0; }

.hud-coord-label {
  font: 600 7px var(--font-mono);
  letter-spacing: 3px;
  text-transform: uppercase;
  color: rgba(255, 255, 255, 0.45);
  line-height: 1;
}

.hud-coord-val {
  font: 700 16px var(--font-mono);
  letter-spacing: 0.5px;
  color: rgba(255, 255, 255, 0.75);
  font-variant-numeric: tabular-nums;
  line-height: 1;
}

.hud-coord-val .deg {
  font-weight: 400;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.3);
  margin-left: 1px;
}

/* ── Info Card ──────────────────────── */
.info-card {
  background: rgba(6, 6, 9, 0.72);
  border: 1px solid rgba(255, 255, 255, 0.04);
  border-radius: 4px;
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  overflow: hidden;
  position: relative;
}

.info-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
  opacity: 0.2;
}

.info-card-head {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px 6px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.03);
}

.info-card-head .ic-status {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 6px var(--accent);
  animation: pulse 2s ease-in-out infinite;
}

.info-card-head .ic-title {
  font: 600 8px var(--font-mono);
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: rgba(255, 255, 255, 0.4);
}

.info-card-head .ic-tag {
  margin-left: auto;
  font: 500 7px var(--font-mono);
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--accent);
  opacity: 0.5;
  background: rgba(0, 210, 255, 0.06);
  padding: 2px 5px;
  border-radius: 2px;
}

.info-card-body {
  padding: 8px 12px 10px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.ic-row {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
}

.ic-label {
  font: 500 7px var(--font-mono);
  letter-spacing: 2px;
  text-transform: uppercase;
  color: rgba(255, 255, 255, 0.2);
}

.ic-value {
  font: 600 10px var(--font-mono);
  letter-spacing: 0.5px;
  color: rgba(255, 255, 255, 0.6);
  font-variant-numeric: tabular-nums;
}

.ic-value .hi { color: var(--accent); opacity: 0.8; }

.ic-divider {
  height: 1px;
  background: rgba(255, 255, 255, 0.03);
  margin: 2px 0;
}

.ic-hover-name {
  font: 600 11px var(--font-mono);
  color: rgba(255, 255, 255, 0.75);
  letter-spacing: 0.3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-height: 14px;
  transition: color 0.15s;
}

.ic-hover-detail {
  font: 400 9px var(--font-mono);
  color: rgba(255, 255, 255, 0.25);
  letter-spacing: 0.5px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-height: 12px;
}

/* ── Crosshair ──────────────────────── */
.crosshair {
  position: absolute;
  inset: 0;
  z-index: 45;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s ease-out;
}

.crosshair.active { opacity: 1; }

.ch-h, .ch-h-glow {
  position: absolute;
  left: 0;
  right: 0;
  height: 1px;
}

.ch-h-glow {
  height: 6px;
  margin-top: -3px;
  filter: blur(4px);
  opacity: 0.35;
}

.ch-v, .ch-v-glow {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 1px;
}

.ch-v-glow {
  width: 6px;
  margin-left: -3px;
  filter: blur(4px);
  opacity: 0.35;
}

.ch-diamond {
  position: absolute;
  width: 14px;
  height: 14px;
  border: 1.5px solid;
  border-radius: 1px;
  transform: translate(-50%, -50%) rotate(45deg);
}

.ch-bloom {
  position: absolute;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  filter: blur(10px);
  opacity: 0.45;
}

/* Scan lines ────────────────────────── */
.scanlines {
  position: absolute;
  inset: 0;
  z-index: 40;
  pointer-events: none;
  overflow: hidden;
}

.scanline {
  position: absolute;
  left: 0;
  right: 0;
  height: 1px;
  opacity: 0;
}

.scanline-a {
  background: linear-gradient(90deg,
    transparent 0%,
    rgba(0, 210, 255, 0) 10%,
    rgba(0, 210, 255, 0.25) 30%,
    rgba(0, 210, 255, 0.5) 50%,
    rgba(0, 210, 255, 0.25) 70%,
    rgba(0, 210, 255, 0) 90%,
    transparent 100%
  );
  box-shadow: 0 0 12px 2px rgba(0, 210, 255, 0.15), 0 0 40px 4px rgba(0, 210, 255, 0.06);
  animation: scan-down 8s linear infinite;
}

.scanline-b {
  background: linear-gradient(90deg,
    transparent 0%,
    rgba(255, 45, 85, 0) 15%,
    rgba(255, 45, 85, 0.2) 35%,
    rgba(255, 45, 85, 0.4) 50%,
    rgba(255, 45, 85, 0.2) 65%,
    rgba(255, 45, 85, 0) 85%,
    transparent 100%
  );
  box-shadow: 0 0 12px 2px rgba(255, 45, 85, 0.12), 0 0 40px 4px rgba(255, 45, 85, 0.05);
  animation: scan-up 6s linear infinite;
  animation-delay: 2s;
}

@keyframes scan-down {
  0%   { top: -2px; opacity: 0; }
  5%   { opacity: 0.8; }
  50%  { opacity: 0.6; }
  95%  { opacity: 0.8; }
  100% { top: 100%; opacity: 0; }
}

@keyframes scan-up {
  0%   { top: calc(100% + 2px); opacity: 0; }
  5%   { opacity: 0.7; }
  50%  { opacity: 0.5; }
  95%  { opacity: 0.7; }
  100% { top: -2px; opacity: 0; }
}

.scanline-v {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 1px;
  left: 0;
  opacity: 0;
  background: linear-gradient(0deg,
    transparent 0%,
    rgba(122, 255, 58, 0) 10%,
    rgba(122, 255, 58, 0.2) 30%,
    rgba(122, 255, 58, 0.45) 50%,
    rgba(122, 255, 58, 0.2) 70%,
    rgba(122, 255, 58, 0) 90%,
    transparent 100%
  );
  box-shadow: 0 0 12px 2px rgba(122, 255, 58, 0.12), 0 0 40px 4px rgba(122, 255, 58, 0.05);
  animation: scan-right 10s linear infinite;
  animation-delay: 4s;
}

@keyframes scan-right {
  0%   { left: -2px; opacity: 0; }
  5%   { opacity: 0.7; }
  50%  { opacity: 0.5; }
  95%  { opacity: 0.7; }
  100% { left: 100%; opacity: 0; }
}

/* ── Briefing Modal ─────────────────── */
.modal-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: rgba(4, 4, 8, 0.92);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.5s ease;
}

.modal-overlay.out {
  opacity: 0;
  pointer-events: none;
}

.modal {
  width: 420px;
  max-width: 90vw;
  position: relative;
}

.modal::before {
  content: '';
  position: absolute;
  inset: -1px;
  border-radius: 7px;
  background: linear-gradient(135deg, rgba(0,210,255,0.15), transparent 40%, transparent 60%, rgba(0,210,255,0.08));
  z-index: -1;
}

.modal-inner {
  background: rgba(10, 10, 16, 0.95);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 6px;
  overflow: hidden;
}

.modal-head {
  padding: 24px 28px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-head .m-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 10px var(--accent), 0 0 30px rgba(0,210,255,0.2);
  animation: pulse 2s ease-in-out infinite;
}

.modal-head .m-tag {
  font: 600 8px var(--font-mono);
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.25);
}

.modal-head .m-status {
  margin-left: auto;
  font: 500 7px var(--font-mono);
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--accent);
  opacity: 0.5;
  background: rgba(0,210,255,0.06);
  padding: 3px 7px;
  border-radius: 2px;
}

.modal-title {
  padding: 16px 28px 0;
  font: 700 22px var(--font-mono);
  letter-spacing: 1px;
  color: var(--text-bright);
  line-height: 1.3;
}

.modal-subtitle {
  padding: 6px 28px 0;
  font: 400 11px var(--font-mono);
  color: var(--text-dim);
  letter-spacing: 0.5px;
  line-height: 1.5;
}

.modal-stats {
  display: flex;
  gap: 1px;
  margin: 20px 28px 0;
}

.modal-stat {
  flex: 1;
  background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.04);
  padding: 10px;
  text-align: center;
}

.modal-stat:first-child { border-radius: 4px 0 0 4px; }
.modal-stat:last-child { border-radius: 0 4px 4px 0; }

.modal-stat .ms-val {
  font: 700 20px var(--font-mono);
  color: var(--text-bright);
}

.modal-stat .ms-label {
  font: 500 7px var(--font-mono);
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-top: 4px;
}

.modal-actions {
  padding: 24px 28px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.btn-briefing {
  width: 100%;
  padding: 12px;
  background: rgba(0, 210, 255, 0.08);
  border: 1px solid rgba(0, 210, 255, 0.2);
  border-radius: 4px;
  color: var(--accent);
  font: 600 11px var(--font-mono);
  letter-spacing: 2px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.btn-briefing::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent, rgba(0,210,255,0.06), transparent);
  animation: btn-shimmer 3s linear infinite;
}

@keyframes btn-shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.btn-briefing:hover {
  background: rgba(0, 210, 255, 0.14);
  border-color: rgba(0, 210, 255, 0.35);
  box-shadow: 0 0 20px rgba(0, 210, 255, 0.1);
}

.btn-explore {
  width: 100%;
  padding: 10px;
  background: transparent;
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 4px;
  color: var(--text-dim);
  font: 500 10px var(--font-mono);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-explore:hover {
  border-color: rgba(255, 255, 255, 0.12);
  color: var(--text);
}

/* ── Tour HUD ──────────────────────── */
.tour-hud {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9000;
  display: none;
  align-items: center;
  gap: 2px;
  background: rgba(8, 8, 14, 0.88);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 6px;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  padding: 8px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.5);
}

.tour-hud.active { display: flex; }

.tour-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 0 14px;
  min-width: 200px;
}

.tour-folder-name {
  font: 600 10px var(--font-mono);
  letter-spacing: 0.5px;
  color: var(--text-bright);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.tour-poi-name {
  font: 400 9px var(--font-mono);
  color: var(--text-dim);
  letter-spacing: 0.3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.tour-progress {
  font: 600 8px var(--font-mono);
  color: var(--text-dim);
  letter-spacing: 1px;
  padding: 0 10px;
  white-space: nowrap;
}

.tour-btn {
  padding: 8px 14px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 4px;
  color: var(--text);
  font: 500 9px var(--font-mono);
  letter-spacing: 1px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}

.tour-btn:hover {
  background: rgba(255, 255, 255, 0.06);
  color: var(--text-bright);
}

.tour-btn.primary {
  background: rgba(0, 210, 255, 0.08);
  border-color: rgba(0, 210, 255, 0.2);
  color: var(--accent);
}

.tour-btn.primary:hover {
  background: rgba(0, 210, 255, 0.14);
}

.tour-divider {
  width: 1px;
  height: 28px;
  background: rgba(255,255,255,0.06);
  margin: 0 4px;
}

/* ── Mobile ─────────────────────────── */
@media (max-width: 768px) {
  #sidebar { width: 100%; min-width: 0; max-height: 40vh; border-right: none; border-bottom: 1px solid var(--border); }
  #app { flex-direction: column; }
  .hud-panel { display: none; }
}
</style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="header">
      <div class="header-title">
        <span class="blink"></span>
        WITW // 26
      </div>
      <div class="header-sub">Smoky Mountain Route Database</div>
      <div class="stats">
        <div class="stat-cell">
          <div class="stat-val" id="s-routes">0</div>
          <div class="stat-label">Routes</div>
        </div>
        <div class="stat-cell">
          <div class="stat-val" id="s-pois">0</div>
          <div class="stat-label">POIs</div>
        </div>
        <div class="stat-cell">
          <div class="stat-val" id="s-folders">0</div>
          <div class="stat-label">Groups</div>
        </div>
      </div>
    </div>
    <div class="search">
      <input type="text" id="search" placeholder="> search routes..." autocomplete="off" spellcheck="false">
    </div>
    <div class="folders" id="folders"></div>
  </div>
  <div id="map-container">
    <div id="map"></div>
    <div class="tooltip" id="tooltip"></div>
    <div class="crosshair" id="crosshair">
      <div class="ch-h-glow" id="ch-hg"></div>
      <div class="ch-h" id="ch-h"></div>
      <div class="ch-v-glow" id="ch-vg"></div>
      <div class="ch-v" id="ch-v"></div>
      <div class="ch-bloom" id="ch-bloom"></div>
      <div class="ch-diamond" id="ch-diamond"></div>
    </div>
    <div class="scanlines">
      <div class="scanline scanline-a"></div>
    </div>
    <div class="hud-panel hud-tl">
      <div class="hud-coords-panel" id="hud-coords">
        <div class="hud-coord-cell">
          <span class="hud-coord-label">lat</span>
          <span class="hud-coord-val" id="hud-lat">---.---<span class="deg">°</span></span>
        </div>
        <div class="hud-coord-cell">
          <span class="hud-coord-label">lng</span>
          <span class="hud-coord-val" id="hud-lng">---.---<span class="deg">°</span></span>
        </div>
      </div>
    </div>
    <div class="hud-panel hud-tr">
      <div class="hud-chip">
        <span class="hud-lbl">zoom</span>
        <span class="hud-val" id="hud-zoom">7.0</span>
      </div>
    </div>
    <div class="hud-panel hud-bl">
      <div class="info-card">
        <div class="info-card-head">
          <div class="ic-status"></div>
          <span class="ic-title">Route Spec</span>
          <span class="ic-tag">Live</span>
        </div>
        <div class="info-card-body">
          <div class="ic-row">
            <span class="ic-label">Brg</span>
            <span class="ic-value" id="hud-bearing"><span class="hi">000</span>°</span>
          </div>
          <div class="ic-row">
            <span class="ic-label">Visible</span>
            <span class="ic-value" id="ic-visible">-- routes / -- pts</span>
          </div>
          <div class="ic-row">
            <span class="ic-label">Extent</span>
            <span class="ic-value" id="ic-extent">--</span>
          </div>
          <div class="ic-divider"></div>
          <div class="ic-hover-name" id="ic-name">&nbsp;</div>
          <div class="ic-hover-detail" id="ic-detail">&nbsp;</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Briefing Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-inner">
        <div class="modal-head">
          <div class="m-dot"></div>
          <span class="m-tag">System Ready</span>
          <span class="m-status">WITW 26</span>
        </div>
        <div class="modal-title">Smoky Mountain<br>Route Network</div>
        <div class="modal-subtitle">9 route groups across Appalachia. Tail of the Dragon, Cherohala Skyway, Blue Ridge Parkway, and more.</div>
        <div class="modal-stats">
          <div class="modal-stat">
            <div class="ms-val" id="m-routes">--</div>
            <div class="ms-label">Routes</div>
          </div>
          <div class="modal-stat">
            <div class="ms-val" id="m-pois">--</div>
            <div class="ms-label">Waypoints</div>
          </div>
          <div class="modal-stat">
            <div class="ms-val" id="m-groups">--</div>
            <div class="ms-label">Groups</div>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn-briefing" id="btn-briefing">Route Briefing</button>
          <button class="btn-explore" id="btn-explore">Free Roam</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tour HUD -->
  <div class="tour-hud" id="tour-hud">
    <button class="tour-btn" id="tour-prev">Prev</button>
    <div class="tour-divider"></div>
    <div class="tour-info">
      <div class="tour-folder-name" id="tour-folder">--</div>
      <div class="tour-poi-name" id="tour-poi">--</div>
    </div>
    <div class="tour-progress" id="tour-progress">0/0</div>
    <div class="tour-divider"></div>
    <button class="tour-btn primary" id="tour-next">Next</button>
    <button class="tour-btn" id="tour-exit">Exit</button>
  </div>
</div>

<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script>
const COLORS = [
  '#00d2ff', // electric cyan
  '#ff2d55', // racing red
  '#7aff3a', // acid green
  '#ff8800', // hot amber
  '#c840ff', // ultraviolet
  '#ffe600', // signal yellow
  '#00e87a', // matrix green
  '#ff5e00', // blaze orange
  '#4488ff', // cobalt
];

let data = null;
let map = null;
let vis = {};
let openFolders = {};
let shimmerPhase = 0;

// ── Init ─────────────────────────────
async function init() {
  const r = await fetch('data.json');
  data = await r.json();

  let nR = 0, nP = 0;
  data.folders.forEach(f => { nR += f.routes.length; nP += f.pois.length; });
  document.getElementById('s-routes').textContent = nR;
  document.getElementById('s-pois').textContent = nP;
  document.getElementById('s-folders').textContent = data.folders.length;
  // Modal stats
  document.getElementById('m-routes').textContent = nR;
  document.getElementById('m-pois').textContent = nP;
  document.getElementById('m-groups').textContent = data.folders.length;

  data.folders.forEach((_, i) => { vis[i] = true; openFolders[i] = false; });
  buildSidebar();
  initMap();
}

// ── Sidebar ──────────────────────────
function buildSidebar() {
  const c = document.getElementById('folders');
  c.innerHTML = '';
  const q = document.getElementById('search').value.toLowerCase();

  data.folders.forEach((folder, fi) => {
    const color = COLORS[fi % COLORS.length];
    const routes = folder.routes.filter(r => !q || r.properties.name.toLowerCase().includes(q));
    const pois = folder.pois.filter(p => !q || p.properties.name.toLowerCase().includes(q));
    const nameMatch = !q || folder.name.toLowerCase().includes(q);
    if (!nameMatch && !routes.length && !pois.length) return;

    const el = document.createElement('div');
    el.className = 'folder';

    el.innerHTML = `
      <div class="folder-head">
        <div class="f-toggle ${vis[fi] ? 'on' : ''}" style="color:${color};border-color:${color}" data-fi="${fi}"></div>
        <svg class="f-chevron ${openFolders[fi] ? 'open' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        <span class="f-name">${folder.name}</span>
        <span class="f-badge">${routes.length + pois.length}</span>
      </div>
      <div class="f-items ${openFolders[fi] ? 'open' : ''}">
        ${routes.map((r, ri) => `
          <div class="f-item" data-t="r" data-fi="${fi}" data-i="${ri}">
            <div class="f-item-dot route" style="background:${color};box-shadow:0 0 4px ${color}"></div>
            <span class="f-item-name">${cleanName(r.properties.name)}</span>
            <span class="f-item-tag">route</span>
          </div>`).join('')}
        ${pois.map((p, pi) => `
          <div class="f-item ${tourFocus && tourFocus.fi === fi && tourFocus.pi === pi ? 'tour-focus' : ''}" data-t="p" data-fi="${fi}" data-i="${pi}">
            <div class="f-item-dot" style="background:${color};box-shadow:0 0 4px ${color}"></div>
            <span class="f-item-name">${p.properties.name}</span>
            <span class="f-item-tag">poi</span>
          </div>`).join('')}
      </div>`;

    el.querySelector('.f-toggle').addEventListener('click', e => {
      e.stopPropagation();
      vis[fi] = !vis[fi];
      syncVis();
      buildSidebar();
    });

    el.querySelector('.folder-head').addEventListener('click', () => {
      openFolders[fi] = !openFolders[fi];
      buildSidebar();
    });

    el.querySelectorAll('.f-item').forEach(item => {
      item.addEventListener('click', e => {
        e.stopPropagation();
        const fIdx = +item.dataset.fi;
        const idx = +item.dataset.i;
        if (item.dataset.t === 'r') flyToRoute(data.folders[fIdx].routes[idx]);
        else flyToPoint(data.folders[fIdx].pois[idx].geometry.coordinates);
      });

      // Hover — crosshair + ease to center
      item.addEventListener('mouseenter', () => {
        if (!map) return;
        const fIdx = +item.dataset.fi;
        const idx = +item.dataset.i;
        const color = COLORS[fIdx % COLORS.length];
        const folderName = data.folders[fIdx].name;

        if (item.dataset.t === 'p') {
          const poi = data.folders[fIdx].pois[idx];
          const coords = poi.geometry.coordinates;
          map.easeTo({ center: coords, duration: 600 });
          crosshairToCoords(coords, color);
          const onMove = () => crosshairToCoords(coords, color);
          map.on('move', onMove);
          item._chCleanup = () => map.off('move', onMove);
          updateInfoCard(poi.properties.name, `${folderName} // POI`, color);
        } else {
          const route = data.folders[fIdx].routes[idx];
          const cs = route.geometry.coordinates;
          let b = [Infinity, Infinity, -Infinity, -Infinity];
          cs.forEach(([x, y]) => { b[0] = Math.min(b[0], x); b[1] = Math.min(b[1], y); b[2] = Math.max(b[2], x); b[3] = Math.max(b[3], y); });
          const center = [(b[0] + b[2]) / 2, (b[1] + b[3]) / 2];
          map.easeTo({ center, duration: 600 });
          crosshairToCoords(center, color);
          const onMove = () => crosshairToCoords(center, color);
          map.on('move', onMove);
          item._chCleanup = () => map.off('move', onMove);
          updateInfoCard(cleanName(route.properties.name), `${folderName} // ROUTE`, color);
        }
      });

      item.addEventListener('mouseleave', () => {
        hideCrosshair();
        clearInfoCard();
        if (item._chCleanup) { item._chCleanup(); item._chCleanup = null; }
      });
    });

    c.appendChild(el);
  });

  // Auto-scroll tour focus into view
  const focused = c.querySelector('.tour-focus');
  if (focused) {
    focused.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

function cleanName(n) {
  return n.replace(/^(Start|End) of (Track|TRK)[\s-]*/i, '').replace(/\s*\(Track\)\s*$/i, '').replace(/\s*- SHP\s*$/i, '').trim();
}

document.getElementById('search').addEventListener('input', buildSidebar);

// ── Map ──────────────────────────────
function initMap() {
  map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'carto': {
          type: 'raster',
          tiles: ['https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'],
          tileSize: 256,
          attribution: '&copy; CARTO &copy; OSM',
        }
      },
      layers: [{ id: 'base', type: 'raster', source: 'carto' }],
      glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
    },
    center: [-83, 35.6],
    zoom: 7,
    maxZoom: 18,
    attributionControl: false,
  });

  map.addControl(new maplibregl.NavigationControl({ showCompass: true }), 'bottom-right');

  map.on('load', () => {
    addRoutes();
    addPOIs();
    map.fitBounds(data.bounds, { padding: 60, duration: 1500 });
    setupInteraction();
    startShimmer();
  });

  // HUD updates
  map.on('move', () => { updateHUD(); updateInfoCardStats(); });
  map.on('zoom', () => { updateHUD(); updateInfoCardStats(); });
}

function updateHUD() {
  const c = map.getCenter();
  document.getElementById('hud-lat').innerHTML =
    `${c.lat.toFixed(4)}<span class="deg">°</span>`;
  document.getElementById('hud-lng').innerHTML =
    `${c.lng.toFixed(4)}<span class="deg">°</span>`;
  document.getElementById('hud-zoom').textContent = map.getZoom().toFixed(1);
  const b = Math.round((map.getBearing() + 360) % 360);
  document.getElementById('hud-bearing').innerHTML =
    `<span class="hi">${String(b).padStart(3, '0')}</span>°`;
}

function addRoutes() {
  data.folders.forEach((folder, fi) => {
    const color = COLORS[fi % COLORS.length];
    const fc = {
      type: 'FeatureCollection',
      features: folder.routes.map(r => ({ ...r, properties: { ...r.properties, fi } })),
    };

    // Main source
    map.addSource(`r-${fi}`, { type: 'geojson', data: fc });

    // Shimmer source (lineMetrics needed for line-gradient)
    // Each route gets its own source for line-gradient
    folder.routes.forEach((route, ri) => {
      const shimmerFc = {
        type: 'FeatureCollection',
        features: [{ ...route, properties: { ...route.properties, fi } }],
      };
      map.addSource(`shimmer-${fi}-${ri}`, { type: 'geojson', data: shimmerFc, lineMetrics: true });
    });

    // Mega glow — outermost halo
    map.addLayer({
      id: `r-mega-${fi}`, type: 'line', source: `r-${fi}`,
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: { 'line-color': color, 'line-width': 28, 'line-opacity': 0.06, 'line-blur': 16 },
    });

    // Glow — wide bloom
    map.addLayer({
      id: `r-glow-${fi}`, type: 'line', source: `r-${fi}`,
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: { 'line-color': color, 'line-width': 16, 'line-opacity': 0.14, 'line-blur': 8 },
    });

    // Mid glow — tighter hot zone
    map.addLayer({
      id: `r-mid-${fi}`, type: 'line', source: `r-${fi}`,
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: { 'line-color': color, 'line-width': 7, 'line-opacity': 0.3, 'line-blur': 2 },
    });

    // Core — bright crisp center
    map.addLayer({
      id: `r-core-${fi}`, type: 'line', source: `r-${fi}`,
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: { 'line-color': color, 'line-width': 2.5, 'line-opacity': 1 },
    });

    // Hot center — white-hot inner line for extra punch
    map.addLayer({
      id: `r-hot-${fi}`, type: 'line', source: `r-${fi}`,
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.15 },
    });

    // Shimmer layers (one per route, using line-gradient)
    folder.routes.forEach((_, ri) => {
      map.addLayer({
        id: `shimmer-${fi}-${ri}`, type: 'line', source: `shimmer-${fi}-${ri}`,
        layout: { 'line-join': 'round', 'line-cap': 'round' },
        paint: {
          'line-color': 'white',
          'line-width': 3,
          'line-opacity': 0.6,
          'line-blur': 1,
          'line-gradient': buildShimmerGradient(0),
        },
      });
    });
  });
}

function buildShimmerGradient(phase) {
  // Creates a line-gradient with a bright "pulse" that sweeps along the route
  const p = phase % 1;
  const width = 0.06; // pulse width as fraction of line length
  const lead = Math.min(Math.max(p, 0), 1);
  const tail = Math.max(lead - width, 0);
  const head = Math.min(lead + width, 1);

  // Clamp everything to [0,1] and ensure stops are ordered
  const stops = [];
  stops.push([0, 'rgba(255,255,255,0)']);
  if (tail > 0.001) stops.push([tail, 'rgba(255,255,255,0)']);
  stops.push([lead, 'rgba(255,255,255,0.45)']);
  if (head < 0.999) stops.push([head, 'rgba(255,255,255,0)']);
  stops.push([1, 'rgba(255,255,255,0)']);

  return ['interpolate', ['linear'], ['line-progress'],
    ...stops.flat()
  ];
}

function startShimmer() {
  const speed = 0.003; // fraction per frame (~60fps => ~5.5s per full sweep)

  function tick() {
    shimmerPhase = (shimmerPhase + speed) % 1.3; // go past 1 for gap between pulses
    const gradient = buildShimmerGradient(shimmerPhase);

    data.folders.forEach((folder, fi) => {
      if (!vis[fi]) return;
      folder.routes.forEach((_, ri) => {
        const layerId = `shimmer-${fi}-${ri}`;
        if (map.getLayer(layerId)) {
          map.setPaintProperty(layerId, 'line-gradient', gradient);
        }
      });
    });

    requestAnimationFrame(tick);
  }

  requestAnimationFrame(tick);
}

function addPOIs() {
  data.folders.forEach((folder, fi) => {
    const color = COLORS[fi % COLORS.length];
    const fc = {
      type: 'FeatureCollection',
      features: folder.pois.map(p => ({ ...p, properties: { ...p.properties, fi } })),
    };

    map.addSource(`p-${fi}`, { type: 'geojson', data: fc });

    // Outer glow
    map.addLayer({
      id: `p-outer-${fi}`, type: 'circle', source: `p-${fi}`,
      paint: { 'circle-radius': 20, 'circle-color': color, 'circle-opacity': 0.06, 'circle-blur': 1.2 },
    });

    // Glow
    map.addLayer({
      id: `p-glow-${fi}`, type: 'circle', source: `p-${fi}`,
      paint: { 'circle-radius': 10, 'circle-color': color, 'circle-opacity': 0.18, 'circle-blur': 0.8 },
    });

    // Core
    map.addLayer({
      id: `p-core-${fi}`, type: 'circle', source: `p-${fi}`,
      paint: {
        'circle-radius': 4, 'circle-color': color, 'circle-opacity': 1,
        'circle-stroke-color': '#fff', 'circle-stroke-width': 0.8, 'circle-stroke-opacity': 0.35,
      },
    });

    // Label
    map.addLayer({
      id: `p-label-${fi}`, type: 'symbol', source: `p-${fi}`,
      layout: {
        'text-field': ['get', 'name'], 'text-size': 10,
        'text-offset': [0, 1.3], 'text-anchor': 'top', 'text-max-width': 12,
        'text-font': ['Open Sans Regular'],
      },
      paint: { 'text-color': '#8888aa', 'text-halo-color': 'rgba(6,6,9,0.85)', 'text-halo-width': 1.5 },
      minzoom: 10,
    });
  });
}

function syncVis() {
  if (!map?.isStyleLoaded()) return;
  data.folders.forEach((folder, fi) => {
    const v = vis[fi] ? 'visible' : 'none';
    [`r-mega-${fi}`, `r-glow-${fi}`, `r-mid-${fi}`, `r-core-${fi}`, `r-hot-${fi}`, `p-outer-${fi}`, `p-glow-${fi}`, `p-core-${fi}`, `p-label-${fi}`].forEach(id => {
      if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', v);
    });
    folder.routes.forEach((_, ri) => {
      const id = `shimmer-${fi}-${ri}`;
      if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', v);
    });
  });
}

function flyToRoute(route) {
  const cs = route.geometry.coordinates;
  let b = [Infinity, Infinity, -Infinity, -Infinity];
  cs.forEach(([x, y]) => { b[0] = Math.min(b[0], x); b[1] = Math.min(b[1], y); b[2] = Math.max(b[2], x); b[3] = Math.max(b[3], y); });
  map.fitBounds([[b[0], b[1]], [b[2], b[3]]], { padding: 80, duration: 1500 });
}

function flyToPoint(c) {
  map.flyTo({ center: c, zoom: 13, duration: 1500 });
}

// ── Crosshair (global) ───────────────
const _ch = {};
function initCrosshair() {
  _ch.el = document.getElementById('crosshair');
  _ch.h = document.getElementById('ch-h');
  _ch.hg = document.getElementById('ch-hg');
  _ch.v = document.getElementById('ch-v');
  _ch.vg = document.getElementById('ch-vg');
  _ch.diamond = document.getElementById('ch-diamond');
  _ch.bloom = document.getElementById('ch-bloom');
}

function hexToRgb(hex) {
  const r = parseInt(hex.slice(1,3), 16);
  const g = parseInt(hex.slice(3,5), 16);
  const b = parseInt(hex.slice(5,7), 16);
  return `${r},${g},${b}`;
}

function showCrosshair(x, y, color) {
  const rgb = hexToRgb(color);
  _ch.el.classList.add('active');

  // Horizontal line
  _ch.h.style.top = y + 'px';
  _ch.h.style.background = `linear-gradient(90deg, transparent, rgba(${rgb},0) 5%, rgba(${rgb},0.55) 25%, rgba(${rgb},1) 50%, rgba(${rgb},0.55) 75%, rgba(${rgb},0) 95%, transparent)`;

  _ch.hg.style.top = y + 'px';
  _ch.hg.style.background = color;

  // Vertical line
  _ch.v.style.left = x + 'px';
  _ch.v.style.background = `linear-gradient(0deg, transparent, rgba(${rgb},0) 5%, rgba(${rgb},0.55) 25%, rgba(${rgb},1) 50%, rgba(${rgb},0.55) 75%, rgba(${rgb},0) 95%, transparent)`;

  _ch.vg.style.left = x + 'px';
  _ch.vg.style.background = color;

  // Center
  _ch.diamond.style.top = y + 'px';
  _ch.diamond.style.left = x + 'px';
  _ch.diamond.style.borderColor = color;
  _ch.diamond.style.boxShadow = `0 0 10px ${color}, 0 0 24px rgba(${rgb},0.35)`;

  _ch.bloom.style.top = y + 'px';
  _ch.bloom.style.left = x + 'px';
  _ch.bloom.style.background = color;
}

function hideCrosshair() {
  _ch.el.classList.remove('active');
}

function crosshairToCoords(lngLat, color) {
  if (!map) return;
  const pt = map.project(lngLat);
  showCrosshair(pt.x, pt.y, color);
}

// ── Info Card ────────────────────────
function updateInfoCard(name, detail, color) {
  const el = document.getElementById('ic-name');
  const det = document.getElementById('ic-detail');
  el.textContent = name;
  el.style.color = color || 'rgba(255,255,255,0.75)';
  det.textContent = detail || '';
}

function clearInfoCard() {
  document.getElementById('ic-name').innerHTML = '&nbsp;';
  document.getElementById('ic-name').style.color = 'rgba(255,255,255,0.25)';
  document.getElementById('ic-detail').innerHTML = '&nbsp;';
}

function updateInfoCardStats() {
  if (!map || !data) return;
  const bounds = map.getBounds();

  let vRoutes = 0, vPois = 0;
  data.folders.forEach((folder, fi) => {
    if (!vis[fi]) return;
    folder.routes.forEach(r => {
      // Route visible if any coord is in viewport
      if (r.geometry.coordinates.some(([lng, lat]) => bounds.contains([lng, lat]))) vRoutes++;
    });
    folder.pois.forEach(p => {
      const [lng, lat] = p.geometry.coordinates;
      if (bounds.contains([lng, lat])) vPois++;
    });
  });

  document.getElementById('ic-visible').innerHTML =
    `<span class="hi">${vRoutes}</span> routes / <span class="hi">${vPois}</span> pts`;

  // Extent — viewport size in miles (approx)
  const sw = bounds.getSouthWest(), ne = bounds.getNorthEast();
  const latMiles = Math.abs(ne.lat - sw.lat) * 69;
  const lngMiles = Math.abs(ne.lng - sw.lng) * 69 * Math.cos((sw.lat + ne.lat) / 2 * Math.PI / 180);
  document.getElementById('ic-extent').textContent =
    `${Math.round(lngMiles)} x ${Math.round(latMiles)} mi`;
}

// ── Interaction ──────────────────────
function setupInteraction() {
  const tooltip = document.getElementById('tooltip');
  initCrosshair();

  const rLayers = [], pLayers = [];
  data.folders.forEach((_, fi) => { rLayers.push(`r-core-${fi}`); pLayers.push(`p-core-${fi}`); });
  const all = [...rLayers, ...pLayers];

  map.on('mousemove', e => {
    const poiFeats = map.queryRenderedFeatures(e.point, { layers: pLayers });
    const allFeats = map.queryRenderedFeatures(e.point, { layers: all });

    // Crosshair — only on POIs
    if (poiFeats.length) {
      const pf = poiFeats[0];
      const color = COLORS[pf.properties.fi % COLORS.length];
      // Get exact screen position of the POI
      const coords = pf.geometry.coordinates;
      const projected = map.project(coords);
      showCrosshair(projected.x, projected.y, color);
    } else {
      hideCrosshair();
    }

    // Tooltip — on anything
    if (allFeats.length) {
      const f = allFeats[0], p = f.properties;
      const color = COLORS[p.fi % COLORS.length];
      const isR = f.geometry.type.includes('Line');
      let desc = (p.description || '').replace(/<br\s*\/?>/g, ' · ').replace(/<[^>]+>/g, '').trim();
      if (desc.length > 120) desc = desc.slice(0, 120) + '…';

      tooltip.innerHTML = `
        <div class="tt-name"><span class="tt-dot" style="background:${color};box-shadow:0 0 6px ${color}"></span>${p.name}</div>
        <div class="tt-folder">${p.folder} // ${isR ? 'ROUTE' : 'POI'}</div>
        ${desc ? `<div class="tt-desc">${desc}</div>` : ''}`;
      tooltip.style.cssText = `display:block;border-top-color:${color}`;
      tooltip.style.borderImage = `linear-gradient(90deg, ${color}44, ${color}, ${color}44) 1`;
      tooltip.style.borderImageSlice = '1 0 0 0';

      const rect = document.getElementById('map-container').getBoundingClientRect();
      let x = e.point.x + 16, y = e.point.y - 10;
      if (x + 260 > rect.width) x = e.point.x - 276;
      if (y + 100 > rect.height) y = e.point.y - 100;
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
      map.getCanvas().style.cursor = 'pointer';
      // Info card
      updateInfoCard(p.name, `${p.folder} // ${isR ? 'ROUTE' : 'POI'}`, color);
    } else {
      tooltip.style.display = 'none';
      map.getCanvas().style.cursor = '';
      clearInfoCard();
    }
  });

  pLayers.forEach(id => map.on('click', id, e => {
    if (e.features.length) flyToPoint(e.features[0].geometry.coordinates.slice());
  }));

  rLayers.forEach(id => map.on('click', id, e => {
    if (e.features.length) {
      const p = e.features[0].properties;
      const route = data.folders[p.fi].routes.find(r => r.properties.name === p.name);
      if (route) flyToRoute(route);
    }
  }));
}

// ── Modal ────────────────────────────
function showModal() {
  const modal = document.getElementById('modal');
  modal.classList.remove('out');
}

function dismissModal() {
  const modal = document.getElementById('modal');
  modal.classList.add('out');
  setTimeout(() => modal.style.display = 'none', 500);
}

document.getElementById('btn-explore').addEventListener('click', dismissModal);
document.getElementById('btn-briefing').addEventListener('click', () => {
  dismissModal();
  setTimeout(startTour, 600);
});

// ── Tour ─────────────────────────────
let tourSteps = [];
let tourIdx = 0;
let tourActive = false;
let preVis = {};
let tourFocus = null; // { fi, pi } — which sidebar item to highlight

function buildTourSteps() {
  tourSteps = [];
  data.folders.forEach((folder, fi) => {
    // First step for each folder: show the folder overview (fit routes)
    tourSteps.push({ type: 'folder', fi, folder });
    // Then each POI
    folder.pois.forEach((poi, pi) => {
      tourSteps.push({ type: 'poi', fi, pi, poi, folder });
    });
  });
}

function startTour() {
  if (!data || !map) return;
  buildTourSteps();
  if (!tourSteps.length) return;

  // Save current visibility
  data.folders.forEach((_, fi) => { preVis[fi] = vis[fi]; });

  tourActive = true;
  tourIdx = 0;
  document.getElementById('tour-hud').classList.add('active');
  showTourStep();
}

function endTour() {
  tourActive = false;
  tourFocus = null;
  document.getElementById('tour-hud').classList.remove('active');
  hideCrosshair();

  // Restore visibility
  data.folders.forEach((_, fi) => { vis[fi] = preVis[fi] ?? true; });
  syncVis();
  buildSidebar();

  // Fit all
  map.fitBounds(data.bounds, { padding: 60, duration: 1200 });
}

function showTourStep() {
  const step = tourSteps[tourIdx];
  const color = COLORS[step.fi % COLORS.length];

  // Turn off all layers, then turn on only this folder
  data.folders.forEach((_, fi) => { vis[fi] = false; });
  vis[step.fi] = true;
  syncVis();

  // Open this folder in sidebar, set focus
  openFolders[step.fi] = true;
  tourFocus = step.type === 'poi' ? { fi: step.fi, pi: step.pi } : null;
  buildSidebar();

  // Update tour HUD
  document.getElementById('tour-folder').textContent = step.folder.name;
  document.getElementById('tour-folder').style.color = color;
  document.getElementById('tour-progress').textContent = `${tourIdx + 1}/${tourSteps.length}`;

  if (step.type === 'folder') {
    document.getElementById('tour-poi').textContent =
      `${step.folder.routes.length} routes, ${step.folder.pois.length} waypoints`;

    // Fit to folder bounds
    let b = [Infinity, Infinity, -Infinity, -Infinity];
    step.folder.routes.forEach(r => {
      r.geometry.coordinates.forEach(([x, y]) => {
        b[0] = Math.min(b[0], x); b[1] = Math.min(b[1], y);
        b[2] = Math.max(b[2], x); b[3] = Math.max(b[3], y);
      });
    });
    step.folder.pois.forEach(p => {
      const [x, y] = p.geometry.coordinates;
      b[0] = Math.min(b[0], x); b[1] = Math.min(b[1], y);
      b[2] = Math.max(b[2], x); b[3] = Math.max(b[3], y);
    });
    if (b[0] !== Infinity) {
      map.fitBounds([[b[0], b[1]], [b[2], b[3]]], { padding: 100, duration: 1500 });
    }
    hideCrosshair();

    // Update info card
    updateInfoCard(step.folder.name, `GROUP ${step.fi + 1} OF ${data.folders.length}`, color);
  } else {
    const poi = step.poi;
    document.getElementById('tour-poi').textContent = poi.properties.name;

    const coords = poi.geometry.coordinates;
    map.flyTo({ center: coords, zoom: 12, duration: 1800 });

    // Crosshair tracks during fly
    const onMove = () => crosshairToCoords(coords, color);
    map.on('move', onMove);
    // Clean up after fly ends
    map.once('moveend', () => {
      map.off('move', onMove);
      crosshairToCoords(coords, color);
    });

    updateInfoCard(poi.properties.name, `${step.folder.name} // POI`, color);
  }
}

document.getElementById('tour-next').addEventListener('click', () => {
  if (!tourActive) return;
  tourIdx = Math.min(tourIdx + 1, tourSteps.length - 1);
  showTourStep();
});

document.getElementById('tour-prev').addEventListener('click', () => {
  if (!tourActive) return;
  tourIdx = Math.max(tourIdx - 1, 0);
  showTourStep();
});

document.getElementById('tour-exit').addEventListener('click', endTour);

// Keyboard nav during tour
document.addEventListener('keydown', e => {
  if (!tourActive) return;
  if (e.key === 'ArrowRight' || e.key === ' ') {
    e.preventDefault();
    tourIdx = Math.min(tourIdx + 1, tourSteps.length - 1);
    showTourStep();
  } else if (e.key === 'ArrowLeft') {
    e.preventDefault();
    tourIdx = Math.max(tourIdx - 1, 0);
    showTourStep();
  } else if (e.key === 'Escape') {
    endTour();
  }
});

// ── Boot ─────────────────────────────
init();

// Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}
</script>
</body>
</html>
